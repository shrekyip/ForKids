<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¥å¥‡å®è´å†’é™©ï¼šè¶…çº§è®­ç»ƒå¸ˆ</title>
    <style>
        body { font-family: 'PingFang SC', sans-serif; background: #e0e0e0; text-align: center; margin: 0; overflow: hidden; touch-action: manipulation; }
        #game-container { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; background: white; }
        .screen { display: none; width: 100%; flex-grow: 1; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }
        
        /* è§’è‰²é€‰æ‹© */
        .trainer-option { cursor: pointer; margin: 10px; }
        .trainer-img { width: 85px; height: 85px; border-radius: 50%; border: 3px solid #ffcc00; background: #fff; object-fit: cover; }

        /* èƒ½é‡æ¡ */
        .bar-container { width: 75%; height: 25px; background: #eee; border-radius: 15px; overflow: hidden; margin: 15px 0; border: 2px solid #444; }
        #energy-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff9f43, #ff6b6b); transition: width 0.1s; }
        
        /* æŠ•æ·æ¡ */
        #toss-bar { width: 80%; height: 24px; background: #ddd; position: relative; border: 2px solid #555; margin: 20px 0; border-radius: 5px; }
        #toss-cursor { width: 14px; height: 100%; background: #222; position: absolute; left: 0; border-radius: 2px; }
        #target-zone { height: 100%; background: rgba(46, 204, 113, 0.5); position: absolute; border-left: 1px solid #27ae60; border-right: 1px solid #27ae60; }
        
        /* æŒ‰é’® */
        .circle-btn { width: 90px; height: 90px; border-radius: 50%; border: none; background: #ff4757; color: white; font-size: 18px; font-weight: bold; box-shadow: 0 6px #ff6b81; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .circle-btn:active { transform: translateY(3px); box-shadow: 0 2px #ff6b81; }
        
        /* åº•éƒ¨å›¾é‰´ */
        #collection-shelf { width: 100%; height: 110px; background: #2f3542; display: flex; align-items: center; justify-content: center; gap: 12px; border-top: 4px solid #ffa502; }
        .collected-slot { width: 65px; height: 65px; background: #57606f; border-radius: 12px; border: 2px solid #747d8c; display: flex; align-items: center; justify-content: center; position: relative; }
        .collected-slot img { width: 55px; height: 55px; object-fit: contain; }

        .pokemon-img { width: 180px; height: 180px; object-fit: contain; }
        .info-text { font-size: 1.1rem; color: #2f3542; font-weight: bold; margin: 10px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="screen-select" class="screen active">
        <h2>ğŸ‘‹ å°è®­ç»ƒå¸ˆï¼Œè¯·é€‰æ‹©è§’è‰²</h2>
        <div id="trainer-pannel" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
    </div>

    <div id="screen-adventure" class="screen">
        <p id="story-display" class="info-text"></p>
        <div id="hp-indicator" style="color: #ff4757; font-weight: bold;">ğŸ” æ­£åœ¨å¯»æ‰¾ç²¾çµ...</div>
        <div class="bar-container"><div id="energy-fill"></div></div>
        <div style="display: flex; gap: 40px;">
            <button class="circle-btn" onclick="addEnergy()">æŒ‰è¿™é‡Œ</button>
            <button class="circle-btn" onclick="addEnergy()">æŒ‰è¿™é‡Œ</button>
        </div>
    </div>

    <div id="screen-catch" class="screen">
        <h3 id="toss-title" style="margin:5px;">é”å®šç›®æ ‡ï¼</h3>
        <img id="wild-pokemon" class="pokemon-img" src="">
        <p id="pokemon-info" style="font-weight: bold; margin: 5px;"></p>
        <div id="toss-bar">
            <div id="target-zone"></div>
            <div id="toss-cursor"></div>
        </div>
        <button class="circle-btn" style="background:#ffa502; box-shadow: 0 6px #e67e22;" onclick="lockToss()">æ‰”çƒï¼</button>
    </div>

    <div id="screen-win" class="screen">
        <h1 style="color: #ffa502; font-size: 2.5rem;">ğŸ† ä»Šæ—¥æˆå°±</h1>
        <p>ä½ ä»Šå¤©å®Œç¾æ”¶æœäº† 5 åªç¥å¥‡å®è´ï¼</p>
        <button class="circle-btn" style="width:140px; border-radius:15px;" onclick="location.reload()">æ˜å¤©å†æ¥</button>
    </div>

    <div id="collection-shelf">
        <div class="collected-slot" id="slot-0"></div>
        <div class="collected-slot" id="slot-1"></div>
        <div class="collected-slot" id="slot-2"></div>
        <div class="collected-slot" id="slot-3"></div>
        <div class="collected-slot" id="slot-4"></div>
    </div>
</div>

<script>
    // --- éŸ³æ•ˆå¼•æ“ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'click') { // ç‚¹å‡»éŸ³
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, now);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if (type === 'success') { // æˆåŠŸéŸ³
            osc.type = 'square';
            [523, 659, 783, 1046].forEach((f, i) => {
                osc.frequency.setValueAtTime(f, now + i * 0.1);
            });
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc.start(); osc.stop(now + 0.5);
        } else if (type === 'fail') { // å¤±è´¥éŸ³
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.3);
            gain.gain.setValueAtTime(0.1, now);
            osc.start(); osc.stop(now + 0.3);
        } else if (type === 'pop') { // è“„åŠ›æ»¡
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(880, now);
            gain.gain.setValueAtTime(0.2, now);
            osc.start(); osc.stop(now + 0.1);
        }
    }

    // --- æ¸¸æˆæ•°æ® ---
    let caughtCount = 0;
    let energy = 0;
    let decayTimer, tossInterval;
    let currentPokemon, tossStep, errors;
    let cursorPos = 0, cursorDir = 1;
    let currentSessionPokemons = []; // æœ¬æ¬¡ä»»åŠ¡çš„5ä¸ªç²¾çµ

    const pokemonsPool = [
        { name: "çš®å¡ä¸˜", img: "025", difficulty: 1, acc: 25 },
        { name: "å¦™è›™ç§å­", img: "001", difficulty: 1, acc: 25 },
        { name: "æ°å°¼é¾Ÿ", img: "007", difficulty: 1, acc: 25 },
        { name: "å°ç«é¾™", img: "004", difficulty: 1.1, acc: 25 },
        { name: "æ³¢æ³¢", img: "016", difficulty: 0.9, acc: 30 },
        { name: "å¯è¾¾é¸­", img: "054", difficulty: 1.2, acc: 25 },
        { name: "èƒ–ä¸", img: "039", difficulty: 1.1, acc: 25 },
        { name: "å–µå–µ", img: "052", difficulty: 1.3, acc: 22 },
        { name: "ä¼Šå¸ƒ", img: "133", difficulty: 1.5, acc: 20 },
        { name: "å¡æ¯”å…½", img: "143", difficulty: 2.5, acc: 15 },
        { name: "é£é€Ÿç‹—", img: "059", difficulty: 2.0, acc: 18 },
        { name: "å¿«é¾™", img: "149", difficulty: 2.8, acc: 12 },
        { name: "è¶…æ¢¦", img: "150", difficulty: 4.0, acc: 8 },
        { name: "æ´›å¥‡äºš", img: "249", difficulty: 3.8, acc: 10 },
        { name: "çƒˆç©ºå", img: "384", difficulty: 4.5, acc: 7 }
    ];

    // --- é€»è¾‘å¤„ç† ---
    window.onload = function() {
        // 1. åˆå§‹åŒ–è®­ç»ƒå¸ˆ
        const pannel = document.getElementById('trainer-pannel');
        let ids = Array.from({length: 26}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        ids.slice(0, 3).forEach(id => {
            const div = document.createElement('div');
            div.className = 'trainer-option';
            div.onclick = () => { playSound('click'); startGame(); };
            div.innerHTML = `<img src="img/${id}.png" class="trainer-img"><p>é€‰æ‹©æˆ‘</p>`;
            pannel.appendChild(div);
        });
        
        // 2. é¢„é€‰5ä¸ªä¸é‡å¤çš„ç²¾çµ
        currentSessionPokemons = [...pokemonsPool].sort(() => Math.random() - 0.5).slice(0, 5);
    };

    function startGame() {
        document.getElementById('screen-select').classList.remove('active');
        document.getElementById('screen-adventure').classList.add('active');
        initRound();
    }

    function initRound() {
        energy = 0;
        updateEnergyUI();
        currentPokemon = currentSessionPokemons[caughtCount];
        
        const stories = ["æ ‘ä¸›åœ¨æ™ƒåŠ¨ï¼", "æ„Ÿè§‰åˆ°å¼ºå¤§çš„æ°”æ¯ï¼", "ä¸€åªç²¾çµè·³äº†å‡ºæ¥ï¼"];
        document.getElementById('story-display').innerText = stories[Math.floor(Math.random()*stories.length)];
        document.getElementById('hp-indicator').innerText = `å‘ç° ${currentPokemon.name}ï¼å¿«è“„åŠ›ï¼`;
        
        if(decayTimer) clearInterval(decayTimer);
        decayTimer = setInterval(() => {
            if (energy > 0) energy -= 1.3;
            updateEnergyUI();
        }, 150);
    }

    function addEnergy() {
        playSound('click');
        // æ ¹æ®éš¾åº¦è°ƒæ•´ç‚¹å‡»åŠ›åº¦
        energy += (16 / currentPokemon.difficulty);
        if (energy >= 100) {
            energy = 100;
            playSound('pop');
            clearInterval(decayTimer);
            setTimeout(showCatchScreen, 300);
        }
        updateEnergyUI();
    }

    function updateEnergyUI() {
        document.getElementById('energy-fill').style.width = energy + "%";
    }

    function showCatchScreen() {
        document.getElementById('screen-adventure').classList.remove('active');
        document.getElementById('screen-catch').classList.add('active');
        document.getElementById('wild-pokemon').src = `https://assets.pokemon.com/assets/cms2/img/pokedex/full/${currentPokemon.img}.png`;
        document.getElementById('pokemon-info').innerText = `${currentPokemon.name} è¿›å…¥æ•æ‰å¸¦ï¼`;
        
        // è®¾ç½®ç›®æ ‡åŒºåŸŸå¤§å°ï¼ˆå³è¯¯å·®å…è®¸å€¼ï¼‰
        const zone = document.getElementById('target-zone');
        const accWidth = currentPokemon.acc * 2; // è¯¯å·®20%æ„å‘³ç€åŒºåŸŸå®½åº¦40%
        zone.style.width = accWidth + "%";
        zone.style.left = (50 - currentPokemon.acc) + "%";
        
        tossStep = 0; errors = [];
        startTossLoop();
    }

    function startTossLoop() {
        const titles = ["é”å®šæ–¹å‘", "é”å®šé«˜åº¦", "æ§åˆ¶æ—‹è½¬"];
        document.getElementById('toss-title').innerText = titles[tossStep];
        cursorPos = 0;
        let speed = 0.8 + Math.random(); // æ…¢é€Ÿç§»åŠ¨
        
        if(tossInterval) clearInterval(tossInterval);
        tossInterval = setInterval(() => {
            cursorPos += speed * cursorDir;
            if (cursorPos >= 100 || cursorPos <= 0) {
                cursorDir *= -1;
                speed = 0.8 + Math.random();
            }
            document.getElementById('toss-cursor').style.left = cursorPos + "%";
        }, 20);
    }

    function lockToss() {
        playSound('click');
        clearInterval(tossInterval);
        errors.push(Math.abs(cursorPos - 50));
        
        tossStep++;
        if (tossStep < 3) setTimeout(startTossLoop, 400);
        else finishCatch();
    }

    function finishCatch() {
        let avgError = errors.reduce((a, b) => a + b) / 3;
        
        // åˆ¤å®šï¼šå¹³å‡è¯¯å·®æ˜¯å¦å°äºè¯¥ç²¾çµçš„å…è®¸å€¼
        if (avgError <= currentPokemon.acc) {
            playSound('success');
            alert("âœ¨ å¤ªæ£’äº†ï¼æ”¶æœäº† " + currentPokemon.name);
            document.getElementById(`slot-${caughtCount}`).innerHTML = `<img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/${currentPokemon.img}.png">`;
            caughtCount++;
        } else {
            playSound('fail');
            alert("ğŸ’¨ å“å‘€ï¼" + currentPokemon.name + " é€ƒèµ°äº†...");
        }

        if (caughtCount >= 5) {
            document.getElementById('screen-catch').classList.remove('active');
            document.getElementById('screen-win').classList.add('active');
        } else {
            document.getElementById('screen-catch').classList.remove('active');
            document.getElementById('screen-adventure').classList.add('active');
            initRound();
        }
    }

    function updateEnergyUI() {
        document.getElementById('energy-fill').style.width = energy + "%";
    }
</script>
</body>
</html>
