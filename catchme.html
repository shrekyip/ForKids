<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¥å¥‡å®è´ï¼šå¤§å¸ˆæ’è¡Œæ¦œæŒ‘æˆ˜</title>
    <style>
        :root { --primary: #ff4757; --accent: #ffa502; --bg: #f1f2f6; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); text-align: center; margin: 0; overflow: hidden; touch-action: manipulation; }
        #game-container { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; background: white; position: relative; }
        
        /* æ¢å¤æ–‡å­—å¤§å°ä¸å¸ƒå±€ */
        .screen { display: none; width: 100%; flex-grow: 1; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        h1 { font-size: 2.2rem; margin-bottom: 10px; }
        h2 { font-size: 1.8rem; margin: 10px 0; }
        p { font-size: 1.2rem; }

        /* æ¢å¤è®­ç»ƒå¸ˆåœ†å½¢ä¸‰é€‰ä¸€ */
        .trainer-container { display: flex; gap: 20px; justify-content: center; margin-top: 30px; }
        .trainer-card { background: white; border: 4px solid #eee; border-radius: 30px; padding: 20px; width: 100px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .trainer-card:active { transform: scale(0.9); border-color: var(--accent); }
        .trainer-card img { width: 80px; height: 80px; border-radius: 50%; background: #f9f9f9; }
        .trainer-card p { font-size: 16px; font-weight: bold; margin-top: 10px; color: #333; }

        /* æ•æ‰æ ¸å¿ƒåŒºåŸŸ */
        #toss-arena { width: 300px; height: 200px; position: relative; margin: 25px 0; background: #fff; border: 5px solid #333; border-radius: 20px; overflow: hidden; }
        #target-zone { position: absolute; background: rgba(46, 204, 113, 0.5); border: 2px solid #2ecc71; z-index: 1; pointer-events: none; }
        #toss-cursor { width: 26px; height: 26px; background: #222; position: absolute; border-radius: 50%; z-index: 5; border: 3px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transform: translate(-50%, -50%); }
        #orbit-line { position: absolute; width: 150px; height: 150px; border: 2px dashed #ddd; border-radius: 50%; top: 25px; left: 75px; display: none; }

        /* è¿›åº¦æ¡ä¸èƒ½é‡æŒ‰é’® */
        .bar-container { width: 85%; height: 25px; background: #eee; border-radius: 15px; overflow: hidden; margin: 20px 0; border: 3px solid #444; }
        #energy-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff9f43, #ff6b6b); transition: width 0.1s; }
        .circle-btn { width: 110px; height: 110px; border-radius: 50%; border: none; background: var(--primary); color: white; font-size: 20px; font-weight: bold; box-shadow: 0 8px #cf3948; cursor: pointer; }
        .circle-btn:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 2px #cf3948; }

        /* æˆ˜ç»©æŠ¥å‘Šç²¾çµå¢™ */
        #final-team { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 20px 0; max-width: 90%; }
        .team-slot { width: 60px; height: 60px; background: #fff; border-radius: 12px; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .team-slot img { width: 50px; }

        /* æ’è¡Œæ¦œæ ·å¼ */
        #leaderboard { width: 90%; max-height: 220px; overflow-y: auto; background: #fff; border-radius: 15px; padding: 15px; margin-top: 20px; text-align: left; border: 2px solid #eee; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 16px; font-weight: bold; }

        #collection-shelf { width: 100%; height: 85px; background: #2f3542; display: flex; align-items: center; justify-content: center; gap: 10px; border-top: 5px solid var(--accent); }
        .slot { width: 50px; height: 50px; background: #57606f; border-radius: 10px; border: 2px solid #747d8c; display: flex; align-items: center; justify-content: center; }
        .slot img { width: 45px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="screen-select" class="screen active">
        <h1>é€‰æ‹©ä½ çš„æ­æ¡£</h1>
        <div id="trainer-pannel" class="trainer-container"></div>
    </div>

    <div id="screen-adventure" class="screen">
        <p id="story-display" style="font-size: 1.5rem; color: #333;"></p>
        <div class="bar-container"><div id="energy-fill"></div></div>
        <div style="display: flex; gap: 40px;">
            <button class="circle-btn" onclick="addEnergy()">è“„åŠ›!</button>
            <button class="circle-btn" onclick="addEnergy()">è“„åŠ›!</button>
        </div>
    </div>

    <div id="screen-catch" class="screen">
        <h2 id="toss-title">å‡†å¤‡æ•æ‰</h2>
        <img id="wild-pokemon" style="width:160px; margin: 10px 0;" src="">
        <div id="toss-arena">
            <div id="orbit-line"></div>
            <div id="target-zone"></div>
            <div id="toss-cursor"></div>
        </div>
        <button id="lock-btn" class="circle-btn" style="background:var(--accent); box-shadow: 0 8px #e67e22;" onclick="lockToss()">æ•æ‰!</button>
    </div>

    <div id="screen-win" class="screen">
        <h1>å†’é™©æŠ¥å‘Š</h1>
        <div id="final-team"></div>
        <div id="register-area" style="margin-top: 10px;">
            <input type="text" id="player-name" placeholder="è¾“å…¥å§“åç™»è®°" style="font-size:18px; padding:12px; width:160px; border-radius:10px; border:2px solid #ddd">
            <button onclick="submitScore()" style="font-size:18px; padding:12px 25px; background:var(--accent); border:none; border-radius:10px; color:white; font-weight:bold; cursor:pointer; margin-left:10px">æäº¤</button>
        </div>
        <div id="leaderboard">
            <div style="text-align:center; color:#ff4757; font-weight:bold; margin-bottom:10px;">ğŸ† å…¨çƒå¤§å¸ˆæ’è¡Œæ¦œ (å‰10)</div>
            <div id="rank-list" style="color: #666; text-align:center;">æäº¤åæŸ¥çœ‹æ’å</div>
        </div>
        <button class="circle-btn" style="width:180px; height:55px; border-radius:30px; margin-top:20px; font-size:18px;" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>

    <div id="collection-shelf">
        <div class="slot" id="slot-0"></div><div class="slot" id="slot-1"></div><div class="slot" id="slot-2"></div><div class="slot" id="slot-3"></div><div class="slot" id="slot-4"></div>
    </div>
</div>

<script>
    // å·²å¸¦å…¥ä½ æä¾›çš„ Google Apps Script URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzLEqUg5qyBiWN7ovedH6Gu4aYkns_Hnvm0soda2rFGRHFWHKYFbxrFycIF7ZrdF1o43A/exec";

    let attemptCount = 0, successCount = 0;
    let energy = 0, decayTimer, tossInterval, currentPokemon, tossStep, subWins, caughtImages = [];
    let mode = 'H', curX = 150, curY = 100, dir = 1, angle = 0;

    // å®Œæ•´çš„ 30 ä¸ªç²¾çµåº“
    const pokemonsPool = [
        { name: "çš®å¡ä¸˜", img: "025", acc: 14 }, { name: "å¦™è›™ç§å­", img: "001", acc: 15 },
        { name: "å°ç«é¾™", img: "004", acc: 15 }, { name: "æ°å°¼é¾Ÿ", img: "007", acc: 15 },
        { name: "å·´å¤§è¶", img: "012", acc: 13 }, { name: "æ¯”é›•", img: "018", acc: 12 },
        { name: "ä¹å°¾", img: "038", acc: 11 }, { name: "å–·ç«é¾™", img: "006", acc: 10 },
        { name: "è€¿é¬¼", img: "094", acc: 10 }, { name: "æš´é²¤é¾™", img: "130", acc: 9 },
        { name: "å¡æ¯”å…½", img: "143", acc: 11 }, { name: "æ€¥å†»é¸Ÿ", img: "144", acc: 8 },
        { name: "é—ªç”µé¸Ÿ", img: "145", acc: 8 }, { name: "ç«ç„°é¸Ÿ", img: "146", acc: 8 },
        { name: "å¿«é¾™", img: "149", acc: 9 }, { name: "è¶…æ¢¦", img: "150", acc: 5 },
        { name: "æ¢¦å¹»", img: "151", acc: 6 }, { name: "æ´›å¥‡äºš", img: "249", acc: 7 },
        { name: "å‡¤ç‹", img: "250", acc: 7 }, { name: "çƒˆç©ºå", img: "384", acc: 5 },
        { name: "ç›–æ¬§å¡", img: "382", acc: 6 }, { name: "å›ºæ‹‰å¤š", img: "383", acc: 6 },
        { name: "åˆ©æ¬§è·¯", img: "447", acc: 12 }, { name: "è·¯å¡åˆ©æ¬§", img: "448", acc: 9 },
        { name: "è¾¾å…‹è±ä¼Š", img: "491", acc: 7 }, { name: "é˜¿å°”å®™æ–¯", img: "493", acc: 4 },
        { name: "ç”²è´ºå¿è›™", img: "658", acc: 8 }, { name: "ä»™å­ä¼Šå¸ƒ", img: "700", acc: 11 },
        { name: "ç´¢å°”è¿¦é›·æ¬§", img: "791", acc: 7 }, { name: "è‹å“", img: "888", acc: 6 }
    ];

    window.onload = function() {
        const pannel = document.getElementById('trainer-pannel');
        let ids = [1, 2, 3, 4, 5, 6].sort(() => Math.random() - 0.5).slice(0, 3);
        ids.forEach(id => {
            const card = document.createElement('div'); card.className = 'trainer-card';
            card.innerHTML = `<img src="img/${id}.png"><p>å¤§å¸ˆ ${id}</p>`;
            card.onclick = () => { selectTrainer(); };
            pannel.appendChild(card);
        });
        pokemonsForToday = pokemonsPool.sort(() => Math.random() - 0.5).slice(0, 5);
    };

    function selectTrainer() {
        document.getElementById('screen-select').classList.remove('active');
        document.getElementById('screen-adventure').classList.add('active');
        initRound();
    }

    function initRound() {
        energy = 0; updateEnergyUI();
        currentPokemon = pokemonsForToday[attemptCount];
        document.getElementById('story-display').innerText = `å‘ç°é‡ç”Ÿçš„ ${currentPokemon.name}ï¼`;
        if(decayTimer) clearInterval(decayTimer);
        decayTimer = setInterval(() => { if (energy > 0) energy -= 2.2; updateEnergyUI(); }, 150);
    }

    function addEnergy() {
        energy += 12; 
        if (energy >= 100) { energy = 100; clearInterval(decayTimer); showCatchScreen(); }
        updateEnergyUI();
    }

    function showCatchScreen() {
        document.getElementById('screen-adventure').classList.remove('active');
        document.getElementById('screen-catch').classList.add('active');
        document.getElementById('wild-pokemon').src = `https://assets.pokemon.com/assets/cms2/img/pokedex/full/${currentPokemon.img}.png`;
        tossStep = 0; subWins = 0;
        nextTossStage();
    }

    function nextTossStage() {
        const r = Math.random();
        mode = r < 0.34 ? 'H' : (r < 0.67 ? 'V' : 'C');
        const titles = {'H':'æ°´å¹³æ•æ‰', 'V':'å‚ç›´æ•æ‰', 'C':'åœ†å‘¨æ•æ‰'};
        document.getElementById('toss-title').innerText = `${titles[mode]} (${tossStep+1}/3)`;
        setupArena();
        startTossLoop();
    }

    function setupArena() {
        const zone = document.getElementById('target-zone');
        const orbit = document.getElementById('orbit-line');
        zone.style = ""; orbit.style.display = "none";
        const acc = currentPokemon.acc;

        if (mode === 'H') {
            zone.style.width = (acc * 6) + "px"; zone.style.height = "100%"; zone.style.left = (150 - acc*3) + "px";
        } else if (mode === 'V') {
            zone.style.height = (acc * 6) + "px"; zone.style.width = "100%"; zone.style.top = (100 - acc*3) + "px";
        } else if (mode === 'C') {
            orbit.style.display = "block";
            zone.style.width = "48px"; zone.style.height = "48px"; zone.style.borderRadius = "50%";
            zone.style.left = "226px"; zone.style.top = "76px";
        }
    }

    function startTossLoop() {
        curX = 150; curY = 100; angle = 0; dir = 1;
        document.getElementById('lock-btn').disabled = false;
        if(tossInterval) clearInterval(tossInterval);
        tossInterval = setInterval(() => {
            const cursor = document.getElementById('toss-cursor');
            let jitter = Math.sin(Date.now() / 110) * 2.5;
            let speed = 5.8 + jitter;

            if (mode === 'H') {
                curX += speed * dir; if (curX > 285 || curX < 15) dir *= -1;
                cursor.style.left = curX + "px"; cursor.style.top = "100px";
            } else if (mode === 'V') {
                curY += speed * dir; if (curY > 185 || curY < 15) dir *= -1;
                cursor.style.top = curY + "px"; cursor.style.left = "150px";
            } else if (mode === 'C') {
                angle += 0.095; curX = 150 + Math.cos(angle)*75; curY = 100 + Math.sin(angle)*75;
                cursor.style.left = curX + "px"; cursor.style.top = curY + "px";
            }
        }, 20);
    }

    function lockToss() {
        clearInterval(tossInterval);
        document.getElementById('lock-btn').disabled = true;
        let hit = false;
        const accRange = currentPokemon.acc * 3;
        if (mode === 'H') hit = Math.abs(curX - 150) < accRange;
        else if (mode === 'V') hit = Math.abs(curY - 100) < accRange;
        else if (mode === 'C') {
            let nA = angle % (Math.PI * 2);
            hit = Math.abs(nA) < 0.4 || Math.abs(nA - Math.PI*2) < 0.4;
        }

        const cursor = document.getElementById('toss-cursor');
        cursor.style.backgroundColor = hit ? "#2ecc71" : "#e74c3c";

        setTimeout(() => {
            cursor.style.backgroundColor = "#222";
            if (hit) subWins++;
            tossStep++;
            if (tossStep < 3) nextTossStage();
            else finishPokemon();
        }, 800);
    }

    function finishPokemon() {
        const isCaught = subWins >= 2;
        const slot = document.getElementById(`slot-${attemptCount}`);
        if (isCaught) {
            slot.innerHTML = `<img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/${currentPokemon.img}.png">`;
            caughtImages.push(currentPokemon.img);
            successCount++;
            alert("âœ… æˆåŠŸæ•æ‰ï¼" + currentPokemon.name + " åŠ å…¥äº†é˜Ÿä¼ï¼");
        } else {
            slot.innerText = "é€ƒ";
            alert("ğŸ’¨ å“å‘€ï¼" + currentPokemon.name + " æŒ£è„±é€ƒè·‘äº†...");
        }

        attemptCount++;
        if (attemptCount >= 5) showFinalScreen();
        else { document.getElementById('screen-catch').classList.remove('active'); document.getElementById('screen-adventure').classList.add('active'); initRound(); }
    }

    function showFinalScreen() {
        document.getElementById('screen-catch').classList.remove('active');
        document.getElementById('screen-win').classList.add('active');
        const team = document.getElementById('final-team');
        team.innerHTML = ""; // æ¸…ç©º
        caughtImages.forEach(img => {
            team.innerHTML += `<div class="team-slot"><img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/${img}.png"></div>`;
        });
    }

    async function submitScore() {
        const name = document.getElementById('player-name').value;
        if(!name) return alert("è¯·å…ˆè¾“å…¥å¤§åå†æäº¤å“¦ï¼");
        const listDiv = document.getElementById('rank-list');
        listDiv.innerText = "æ­£åœ¨åŒæ­¥å¤§å¸ˆæ¦œå•...";
        
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // ä½¿ç”¨ no-cors æ¨¡å¼ç¡®ä¿è·¨åŸŸè¯·æ±‚å‘å‡º
                body: JSON.stringify({ name: name, score: successCount })
            });
            
            // æç¤ºï¼šç”±äº no-cors æ— æ³•è·å–è¿”å›å†…å®¹ï¼Œ
            // å»ºè®®æäº¤å 1 ç§’æ‰‹åŠ¨åˆ·æ–°æˆ–æç¤ºæˆåŠŸã€‚
            setTimeout(() => {
                listDiv.innerHTML = "<span style='color:green'>æäº¤æˆåŠŸï¼è¯·åœ¨ Google è¡¨æ ¼ä¸­æŸ¥çœ‹æˆ–ä¸‹æ¬¡è¿›å…¥åˆ·æ–°ã€‚</span>";
                document.getElementById('register-area').style.display = 'none';
            }, 1000);
            
        } catch(e) { 
            alert("æäº¤é‡åˆ°äº†ç‚¹å°é—®é¢˜ï¼Œè¯·ç¡®ä¿ Web App å·²æ­£ç¡®éƒ¨ç½²å¹¶å¼€å¯æ‰€æœ‰äººè®¿é—®ã€‚");
        }
    }

    function updateEnergyUI() { document.getElementById('energy-fill').style.width = energy + "%"; }
</script>
</body>
</html>
