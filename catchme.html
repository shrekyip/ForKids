<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¥å¥‡å®è´ï¼šå¤§å¸ˆæ’è¡Œæ¦œ</title>
    <style>
        :root { --primary: #ff4757; --accent: #ffa502; --bg: #f1f2f6; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); text-align: center; margin: 0; overflow: hidden; touch-action: manipulation; }
        #game-container { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; background: white; position: relative; }
        
        /* ç•Œé¢åˆ‡æ¢ */
        .screen { display: none; width: 100%; flex-grow: 1; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        h1 { font-size: 2.2rem; margin: 10px 0; color: #333; }
        h2 { font-size: 1.8rem; margin: 5px 0; }

        /* è®­ç»ƒå¸ˆé€‰æ‹© */
        .trainer-container { display: flex; gap: 20px; justify-content: center; margin-top: 30px; }
        .trainer-card { background: white; border: 4px solid #eee; border-radius: 30px; padding: 15px; width: 95px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .trainer-card img { width: 75px; height: 75px; border-radius: 50%; background: #f9f9f9; }
        .trainer-card p { font-size: 16px; font-weight: bold; margin-top: 10px; }

        /* æ•æ‰åŒºåŸŸ */
        #toss-arena { width: 300px; height: 200px; position: relative; margin: 20px 0; background: #fff; border: 5px solid #333; border-radius: 20px; overflow: hidden; }
        #target-zone { position: absolute; background: rgba(46, 204, 113, 0.5); border: 2px solid #2ecc71; z-index: 1; pointer-events: none; }
        #toss-cursor { width: 26px; height: 26px; background: #222; position: absolute; border-radius: 50%; z-index: 5; border: 3px solid #fff; transform: translate(-50%, -50%); }
        #orbit-line { position: absolute; width: 150px; height: 150px; border: 2px dashed #ddd; border-radius: 50%; top: 25px; left: 75px; display: none; }

        /* è¿›åº¦æ¡ä¸æŒ‰é’® */
        .bar-container { width: 85%; height: 25px; background: #eee; border-radius: 15px; overflow: hidden; margin: 20px 0; border: 3px solid #444; }
        #energy-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff9f43, #ff6b6b); }
        .circle-btn { width: 100px; height: 100px; border-radius: 50%; border: none; background: var(--primary); color: white; font-size: 20px; font-weight: bold; box-shadow: 0 8px #cf3948; cursor: pointer; }
        .circle-btn:active { transform: translateY(4px); box-shadow: 0 2px #cf3948; }

        /* æŠ¥å‘Šé¡µç²¾çµåˆ—è¡¨ */
        #final-team { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 15px 0; max-width: 90%; }
        .team-slot { width: 55px; height: 55px; background: #fff; border-radius: 12px; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; }
        .team-slot img { width: 45px; }

        /* æ’è¡Œæ¦œæ»šåŠ¨åŒº */
        #leaderboard { width: 90%; max-height: 220px; overflow-y: auto; background: #f8f9fa; border-radius: 15px; padding: 15px; border: 2px solid #eee; margin-top: 15px; }
        .rank-item { border-bottom: 1px solid #eee; padding: 10px 0; text-align: left; }
        .rank-main { display: flex; justify-content: space-between; font-weight: bold; font-size: 16px; color: #333; }
        .rank-details { font-size: 12px; color: #888; margin-top: 4px; line-height: 1.4; }

        #collection-shelf { width: 100%; height: 80px; background: #2f3542; display: flex; align-items: center; justify-content: center; gap: 10px; border-top: 5px solid var(--accent); }
        .slot { width: 45px; height: 45px; background: #57606f; border-radius: 8px; border: 1px solid #747d8c; display: flex; align-items: center; justify-content: center; }
        .slot img { width: 40px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="screen-select" class="screen active">
        <h1>é€‰æ‹©æ­æ¡£</h1>
        <div id="trainer-pannel" class="trainer-container"></div>
    </div>

    <div id="screen-adventure" class="screen">
        <p id="story-display" style="font-weight:bold; font-size:1.4rem;"></p>
        <div class="bar-container"><div id="energy-fill"></div></div>
        <button class="circle-btn" onclick="addEnergy()">è“„åŠ›!</button>
    </div>

    <div id="screen-catch" class="screen">
        <h2 id="toss-title">å‡†å¤‡æ•æ‰</h2>
        <img id="wild-pokemon" style="width:140px; margin:10px 0;" src="">
        <div id="toss-arena">
            <div id="orbit-line"></div>
            <div id="target-zone"></div>
            <div id="toss-cursor"></div>
        </div>
        <button id="lock-btn" class="circle-btn" style="background:var(--accent); box-shadow: 0 8px #e67e22;" onclick="lockToss()">é”å®š!</button>
    </div>

    <div id="screen-win" class="screen">
        <h2 style="margin:5px">å†’é™©æŠ¥å‘Š</h2>
        <div id="final-team"></div>
        
        <div id="register-area">
            <input type="text" id="player-name" placeholder="è¾“å…¥å¤§å¸ˆå§“å" style="padding:12px; font-size:16px; width:140px; border-radius:10px; border:2px solid #ddd">
            <button onclick="submitScore()" style="padding:12px 20px; font-size:16px; background:var(--accent); border:none; border-radius:10px; color:white; font-weight:bold; cursor:pointer;">æäº¤æˆ˜ç»©</button>
        </div>

        <div id="leaderboard">
            <div id="rank-list" style="color:#999; text-align:center;">æ­£åœ¨åŒæ­¥æœ€æ–°æ’è¡Œæ¦œ...</div>
        </div>
        <button class="circle-btn" style="width:160px; height:50px; border-radius:25px; margin-top:15px; font-size:18px" onclick="location.reload()">å†æ¬¡å¼€å¯å†’é™©</button>
    </div>

    <div id="collection-shelf">
        <div class="slot" id="slot-0"></div><div class="slot" id="slot-1"></div><div class="slot" id="slot-2"></div><div class="slot" id="slot-3"></div><div class="slot" id="slot-4"></div>
    </div>
</div>

<script>
    // å·²æ›´æ–°ä¸ºä½ æä¾›çš„æ–° URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyENd10dbG6vhvvpZ7Ay4q2_QmJN6VPmnFBCBgow_gr7McQNsRx0BVhMRdNVnqX-lKrzw/exec";

    let attemptCount = 0, successCount = 0;
    let energy = 0, currentPokemon, tossStep, subWins, caughtImages = [], caughtNames = [];
    let mode = 'H', curX = 150, curY = 100, dir = 1, angle = 0, tossInterval;

    const pokemonsPool = [
        { name: "çš®å¡ä¸˜", img: "025", acc: 14 }, { name: "å¦™è›™ç§å­", img: "001", acc: 15 },
        { name: "å°ç«é¾™", img: "004", acc: 15 }, { name: "æ°å°¼é¾Ÿ", img: "007", acc: 15 },
        { name: "å·´å¤§è¶", img: "012", acc: 13 }, { name: "æ¯”é›•", img: "018", acc: 12 },
        { name: "ä¹å°¾", img: "038", acc: 11 }, { name: "å–·ç«é¾™", img: "006", acc: 10 },
        { name: "è€¿é¬¼", img: "094", acc: 10 }, { name: "æš´é²¤é¾™", img: "130", acc: 9 },
        { name: "å¡æ¯”å…½", img: "143", acc: 11 }, { name: "æ€¥å†»é¸Ÿ", img: "144", acc: 8 },
        { name: "é—ªç”µé¸Ÿ", img: "145", acc: 8 }, { name: "ç«ç„°é¸Ÿ", img: "146", acc: 8 },
        { name: "å¿«é¾™", img: "149", acc: 9 }, { name: "è¶…æ¢¦", img: "150", acc: 5 },
        { name: "æ¢¦å¹»", img: "151", acc: 6 }, { name: "æ´›å¥‡äºš", img: "249", acc: 7 },
        { name: "å‡¤ç‹", img: "250", acc: 7 }, { name: "çƒˆç©ºå", img: "384", acc: 5 },
        { name: "ç›–æ¬§å¡", img: "382", acc: 6 }, { name: "å›ºæ‹‰å¤š", img: "383", acc: 6 },
        { name: "åˆ©æ¬§è·¯", img: "447", acc: 12 }, { name: "è·¯å¡åˆ©æ¬§", img: "448", acc: 9 },
        { name: "è¾¾å…‹è±ä¼Š", img: "491", acc: 7 }, { name: "é˜¿å°”å®™æ–¯", img: "493", acc: 4 },
        { name: "ç”²è´ºå¿è›™", img: "658", acc: 8 }, { name: "ä»™å­ä¼Šå¸ƒ", img: "700", acc: 11 },
        { name: "ç´¢å°”è¿¦é›·æ¬§", img: "791", acc: 7 }, { name: "è‹å“", img: "888", acc: 6 }

        // ... æ­¤å¤„å¯æ‰©å±•è‡³30ä¸ª
    ];

    window.onload = () => {
        const pannel = document.getElementById('trainer-pannel');
        [1, 2, 3].sort(()=>Math.random()-0.5).forEach(id => {
            const card = document.createElement('div'); card.className = 'trainer-card';
            card.innerHTML = `<img src="img/${id}.png"><p>ä¼™ä¼´ ${id}</p>`;
            card.onclick = () => { document.getElementById('screen-select').classList.remove('active'); document.getElementById('screen-adventure').classList.add('active'); initRound(); };
            pannel.appendChild(card);
        });
        pokemonsForToday = pokemonsPool.sort(() => Math.random() - 0.5).slice(0, 5);
    };

    function initRound() {
        energy = 0; currentPokemon = pokemonsForToday[attemptCount];
        document.getElementById('story-display').innerText = `å‰æ–¹å‘ç° ${currentPokemon.name}ï¼`;
        const decay = setInterval(() => { if(energy > 0) energy -= 2.2; updateUI(); }, 150);
        window.roundDecay = decay;
    }

    function addEnergy() {
        energy += 15; updateUI();
        if(energy >= 100) { clearInterval(window.roundDecay); showCatch(); }
    }

    function showCatch() {
        document.getElementById('screen-adventure').classList.remove('active');
        document.getElementById('screen-catch').classList.add('active');
        document.getElementById('wild-pokemon').src = `https://assets.pokemon.com/assets/cms2/img/pokedex/full/${currentPokemon.img}.png`;
        tossStep = 0; subWins = 0; randomizeMode();
    }

    function randomizeMode() {
        const r = Math.random();
        mode = r < 0.34 ? 'H' : (r < 0.67 ? 'V' : 'C');
        const zone = document.getElementById('target-zone');
        const orbit = document.getElementById('orbit-line');
        zone.style = ""; orbit.style.display = "none";
        
        const acc = currentPokemon.acc;
        if(mode === 'H') { zone.style.width=(acc*6)+"px"; zone.style.height="100%"; zone.style.left=(150-acc*3)+"px"; }
        else if(mode === 'V') { zone.style.height=(acc*6)+"px"; zone.style.width="100%"; zone.style.top=(100-acc*3)+"px"; }
        else { orbit.style.display="block"; zone.style.width="48px"; zone.style.height="48px"; zone.style.left="226px"; zone.style.top="76px"; zone.style.borderRadius="50%"; }
        
        startLoop();
    }

    function startLoop() {
        curX = 150; curY = 100; angle = 0;
        document.getElementById('toss-title').innerText = `${mode==='H'?'æ°´å¹³':mode==='V'?'å‚ç›´':'åœ†å‘¨'}æ¨¡å¼ (${tossStep+1}/3)`;
        document.getElementById('lock-btn').disabled = false;
        if(tossInterval) clearInterval(tossInterval);
        tossInterval = setInterval(() => {
            const cursor = document.getElementById('toss-cursor');
            if(mode === 'H') { curX += 6 * dir; if(curX > 280 || curX < 20) dir *= -1; cursor.style.left = curX+"px"; cursor.style.top="100px"; }
            else if(mode === 'V') { curY += 6 * dir; if(curY > 180 || curY < 20) dir *= -1; cursor.style.top = curY+"px"; cursor.style.left="150px"; }
            else { angle += 0.1; curX = 150 + Math.cos(angle)*75; curY = 100 + Math.sin(angle)*75; cursor.style.left = curX+"px"; cursor.style.top = curY+"px"; }
        }, 20);
    }

    function lockToss() {
        clearInterval(tossInterval);
        let accRange = currentPokemon.acc * 3;
        let hit = (mode==='H' && Math.abs(curX-150)<accRange) || (mode==='V' && Math.abs(curY-100)<accRange) || (mode==='C' && Math.abs(angle%(Math.PI*2)) < 0.4);
        if(hit) subWins++;
        
        document.getElementById('toss-cursor').style.backgroundColor = hit ? "#2ecc71" : "#e74c3c";
        
        setTimeout(() => {
            document.getElementById('toss-cursor').style.backgroundColor = "#222";
            if(++tossStep < 3) randomizeMode();
            else finish();
        }, 800);
    }

    function finish() {
        const isCaught = subWins >= 2;
        if(isCaught) {
            document.getElementById(`slot-${attemptCount}`).innerHTML = `<img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/${currentPokemon.img}.png">`;
            caughtImages.push(currentPokemon.img);
            caughtNames.push(currentPokemon.name);
            successCount++;
            alert("âœ… æˆåŠŸæ”¶æœ " + currentPokemon.name + "ï¼");
        } else {
            document.getElementById(`slot-${attemptCount}`).innerText = "é€ƒ";
            alert("ğŸ’¨ å“å‘€ï¼" + currentPokemon.name + " é€ƒèµ°äº†...");
        }
        
        if(++attemptCount >= 5) showWin();
        else { document.getElementById('screen-catch').classList.remove('active'); document.getElementById('screen-adventure').classList.add('active'); initRound(); }
    }

    function showWin() {
        document.getElementById('screen-catch').classList.remove('active');
        document.getElementById('screen-win').classList.add('active');
        const team = document.getElementById('final-team');
        team.innerHTML = "";
        caughtImages.forEach(img => {
            team.innerHTML += `<div class="team-slot"><img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/${img}.png"></div>`;
        });
    }

    async function submitScore() {
        const name = document.getElementById('player-name').value;
        if(!name) return alert("è¯·ç•™ä¸‹ä½ çš„å¤§å¸ˆåå·ï¼");
        const listDiv = document.getElementById('rank-list');
        listDiv.innerText = "æ­£åœ¨è·å–æœ€æ–°å¤§å¸ˆæ¦œå•...";
        
        try {
            // å‘é€æ•°æ®å¹¶ç­‰å¾…è¿”å› JSON æ’ååˆ—è¡¨
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    name: name, 
                    score: successCount, 
                    pokemonList: caughtNames 
                })
            });
            const topTen = await response.json();
            renderRanks(topTen);
            document.getElementById('register-area').style.display = 'none';
        } catch(e) { 
            alert("åŒæ­¥æ’è¡Œæ¦œå¤±è´¥ï¼Œæ•°æ®å·²ä¿å­˜è‡³äº‘ç«¯ï¼Œè¯·ç¨ååˆ·æ–°ã€‚");
            listDiv.innerText = "æ— æ³•è¿æ¥è‡³å¤§å¸ˆæœåŠ¡å™¨ã€‚";
        }
    }

    function renderRanks(data) {
        const list = document.getElementById('rank-list');
        list.innerHTML = data.map((item, i) => `
            <div class="rank-item">
                <div class="rank-main">
                    <span>${i+1}. ${item[0]}</span>
                    <span style="color:var(--primary)">${item[1]} åª</span>
                </div>
                <div class="rank-details">æ”¶æœåå•: ${item[2] || 'æš‚æ— '}</div>
            </div>
        `).join('');
    }

    function updateUI() { document.getElementById('energy-fill').style.width = energy+"%"; }
</script>
</body>
</html>
