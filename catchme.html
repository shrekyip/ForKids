<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¥å¥‡å®è´ï¼šå¤§å¸ˆå…¨éšæœºæŒ‘æˆ˜</title>
    <style>
        :root { --primary: #ff4757; --accent: #ffa502; --bg: #f1f2f6; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); text-align: center; margin: 0; overflow: hidden; touch-action: manipulation; }
        #game-container { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; background: white; position: relative; }
        .screen { display: none; width: 100%; flex-grow: 1; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }

        /* çŠ¶æ€æ  */
        #active-trainer-bar { position: absolute; top: 10px; left: 10px; display: none; align-items: center; background: rgba(255,255,255,0.9); padding: 5px 12px; border-radius: 25px; border: 2px solid var(--accent); z-index: 100; }
        #active-trainer-bar img { width: 35px; height: 35px; border-radius: 50%; margin-right: 8px; }

        /* æ ¸å¿ƒæ“‚å° */
        #toss-arena { width: 300px; height: 200px; position: relative; margin: 20px 0; background: #fff; border: 4px solid #333; border-radius: 15px; overflow: hidden; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
        #target-zone { position: absolute; background: rgba(46, 204, 113, 0.5); border: 2px solid #2ecc71; z-index: 1; pointer-events: none; }
        #toss-cursor { width: 24px; height: 24px; background: #222; position: absolute; border-radius: 50%; z-index: 5; border: 3px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transform: translate(-50%, -50%); top: 50%; left: 50%; }
        #orbit-line { position: absolute; width: 150px; height: 150px; border: 2px dashed #eee; border-radius: 50%; top: 25px; left: 75px; display: none; }

        /* èƒ½é‡æ¡ */
        .bar-container { width: 80%; height: 20px; background: #eee; border-radius: 10px; overflow: hidden; margin: 15px 0; border: 2px solid #444; }
        #energy-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff9f43, #ff6b6b); }

        .circle-btn { width: 95px; height: 95px; border-radius: 50%; border: none; background: var(--primary); color: white; font-size: 18px; font-weight: bold; box-shadow: 0 6px #cf3948; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .circle-btn:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 2px #cf3948; }
        .circle-btn:disabled { background: #ccc; box-shadow: none; opacity: 0.6; }

        /* åº•éƒ¨å±•ç¤ºæ¶ */
        #collection-shelf { width: 100%; height: 80px; background: #2f3542; display: flex; align-items: center; justify-content: center; gap: 8px; border-top: 4px solid var(--accent); }
        .slot { width: 45px; height: 45px; background: #57606f; border-radius: 8px; border: 1px solid #747d8c; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .slot img { width: 38px; height: 38px; object-fit: contain; }
        .pokemon-img { width: 150px; height: 150px; object-fit: contain; }
        
        .trainer-container { display: flex; gap: 10px; overflow-x: auto; width: 100%; justify-content: center; }
        .trainer-card { background: white; border: 2px solid #ddd; border-radius: 12px; padding: 10px; min-width: 80px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="active-trainer-bar"><img id="current-trainer-img" src=""><span id="current-trainer-name"></span></div>
    <div style="position: absolute; top: 15px; right: 15px; font-weight: bold; color: #666;">æŒ‘æˆ˜: <span id="attempt-count">0</span>/5</div>

    <div id="screen-select" class="screen active">
        <h2>é€‰æ‹©ä½ çš„å¤§å¸ˆä¼™ä¼´</h2>
        <div id="trainer-pannel" class="trainer-container"></div>
    </div>

    <div id="screen-adventure" class="screen">
        <p id="story-display" style="font-size: 1.2rem; font-weight: bold;"></p>
        <div class="bar-container"><div id="energy-fill"></div></div>
        <div style="display: flex; gap: 40px;">
            <button class="circle-btn" onclick="addEnergy()">å¿«é€Ÿè“„åŠ›</button>
            <button class="circle-btn" onclick="addEnergy()">å¿«é€Ÿè“„åŠ›</button>
        </div>
    </div>

    <div id="screen-catch" class="screen">
        <h3 id="toss-title" style="margin:0 0 10px 0;"></h3>
        <img id="wild-pokemon" class="pokemon-img" src="">
        <div id="toss-arena">
            <div id="orbit-line"></div>
            <div id="target-zone"></div>
            <div id="toss-cursor"></div>
        </div>
        <button id="lock-btn" class="circle-btn" style="background:var(--accent); box-shadow: 0 6px #e67e22;" onclick="lockToss()">æ•æ‰é”å®šï¼</button>
    </div>

    <div id="screen-win" class="screen">
        <h1 style="color: var(--accent);">å†’é™©æŠ¥å‘Š</h1>
        <p id="final-score" style="font-size: 1.2rem; font-weight: bold;"></p>
        <button class="circle-btn" style="width:140px; border-radius:15px;" onclick="location.reload()">å¼€å¯æ–°æŒ‘æˆ˜</button>
    </div>

    <div id="collection-shelf">
        <div class="slot" id="slot-0"></div><div class="slot" id="slot-1"></div><div class="slot" id="slot-2"></div><div class="slot" id="slot-3"></div><div class="slot" id="slot-4"></div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if (type === 'click') { osc.frequency.setValueAtTime(400, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(); osc.stop(now + 0.1); }
        else if (type === 'success') { [523, 659, 783].forEach((f, i) => osc.frequency.setValueAtTime(f, now + i * 0.1)); gain.gain.setValueAtTime(0.1, now); osc.start(); osc.stop(now + 0.4); }
        else if (type === 'fail') { osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3); gain.gain.setValueAtTime(0.1, now); osc.start(); osc.stop(now + 0.3); }
    }

    let attemptCount = 0, successCount = 0;
    let energy = 0, decayTimer, tossInterval, currentPokemon, tossStep, subWins;
    let mode = 'H', angle = 0, curX = 150, curY = 100, dir = 1;

    const pokemonsPool = [
        { name: "çš®å¡ä¸˜", img: "025", diff: 1.2, acc: 14 },
        { name: "è€¿é¬¼", img: "094", diff: 2.2, acc: 10 },
        { name: "æš´é²¤é¾™", img: "130", diff: 2.8, acc: 9 },
        { name: "æ€¥å†»é¸Ÿ", img: "144", diff: 3.8, acc: 7 },
        { name: "è¶…æ¢¦", img: "150", diff: 5.0, acc: 5 },
        { name: "çƒˆç©ºå", img: "384", diff: 5.5, acc: 4 }
    ];

    window.onload = function() {
        const pannel = document.getElementById('trainer-pannel');
        let ids = Array.from({length: 26}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        ids.slice(0, 3).forEach(id => {
            const card = document.createElement('div'); card.className = 'trainer-card';
            card.innerHTML = `<img src="img/${id}.png"><p>å¤§å¸ˆ ${id}</p>`;
            card.onclick = () => selectTrainer(id);
            pannel.appendChild(card);
        });
        pokemonsForToday = [...pokemonsPool].sort(() => Math.random() - 0.5).slice(0, 5);
    };

    function selectTrainer(id) {
        playSound('click');
        document.getElementById('current-trainer-img').src = `img/${id}.png`;
        document.getElementById('current-trainer-name').innerText = `å¤§å¸ˆ ${id}`;
        document.getElementById('active-trainer-bar').style.display = 'flex';
        document.getElementById('screen-select').classList.remove('active');
        document.getElementById('screen-adventure').classList.add('active');
        initRound();
    }

    function initRound() {
        energy = 0; updateEnergyUI();
        currentPokemon = pokemonsForToday[attemptCount];
        document.getElementById('attempt-count').innerText = (attemptCount + 1);
        document.getElementById('story-display').innerText = `å‘ç°ç¥ç§˜çš„ ${currentPokemon.name}...`;
        if(decayTimer) clearInterval(decayTimer);
        decayTimer = setInterval(() => { if (energy > 0) energy -= 2.2; updateEnergyUI(); }, 150);
    }

    function addEnergy() {
        playSound('click');
        energy += (15 / currentPokemon.diff);
        if (energy >= 100) { energy = 100; clearInterval(decayTimer); setTimeout(showCatchScreen, 300); }
        updateEnergyUI();
    }

    function showCatchScreen() {
        document.getElementById('screen-adventure').classList.remove('active');
        document.getElementById('screen-catch').classList.add('active');
        document.getElementById('wild-pokemon').src = `https://assets.pokemon.com/assets/cms2/img/pokedex/full/${currentPokemon.img}.png`;
        
        tossStep = 0; subWins = 0;
        // ç¬¬ä¸€æ¬¡æ•æ‰å‰éšæœºåˆ†é…æ¨¡å¼
        randomizeMode();
        startTossLoop();
    }

    function randomizeMode() {
        const r = Math.random();
        mode = r < 0.34 ? 'H' : (r < 0.67 ? 'V' : 'C');
        setupArena();
    }

    function setupArena() {
        const zone = document.getElementById('target-zone');
        const orbit = document.getElementById('orbit-line');
        const acc = currentPokemon.acc;
        
        zone.style = ""; orbit.style.display = "none";

        if (mode === 'H') {
            const w = acc * 6;
            zone.style.width = w + "px"; zone.style.height = "100%";
            zone.style.left = (150 - w/2) + "px"; zone.style.top = "0";
        } else if (mode === 'V') {
            const h = acc * 6;
            zone.style.height = h + "px"; zone.style.width = "100%";
            zone.style.top = (100 - h/2) + "px"; zone.style.left = "0";
        } else if (mode === 'C') {
            orbit.style.display = "block";
            zone.style.width = "48px"; zone.style.height = "48px";
            zone.style.borderRadius = "50%";
            zone.style.left = "226px"; zone.style.top = "76px"; // 0å¼§åº¦ä¸­å¿ƒä½ç½®
        }
    }

    function startTossLoop() {
        const titles = {'H':'æ°´å¹³æ¨¡å¼', 'V':'å‚ç›´æ¨¡å¼', 'C':'åœ†å‘¨æ¨¡å¼'};
        document.getElementById('toss-title').innerText = `${titles[mode]} (${tossStep+1}/3)`;
        document.getElementById('lock-btn').disabled = false;
        
        // å…³é”®ä¿®å¤ï¼šé‡ç½®ç‰©ç†ä½ç½®ï¼Œé˜²æ­¢å¡å‡ºè¾¹ç•Œ
        curX = 150; curY = 100; angle = 0; dir = 1;
        
        if(tossInterval) clearInterval(tossInterval);
        tossInterval = setInterval(() => {
            const cursor = document.getElementById('toss-cursor');
            let jitter = Math.sin(Date.now() / 100) * 2.5; // æå‡æŠ–åŠ¨æ„Ÿ
            let speed = 5.5 * 1.1 + jitter;

            if (mode === 'H') {
                curX += speed * dir;
                if (curX > 285) { curX = 285; dir = -1; }
                if (curX < 15) { curX = 15; dir = 1; }
                cursor.style.left = curX + "px"; cursor.style.top = "100px";
            } else if (mode === 'V') {
                curY += speed * dir;
                if (curY > 185) { curY = 185; dir = -1; }
                if (curY < 15) { curY = 15; dir = 1; }
                cursor.style.top = curY + "px"; cursor.style.left = "150px";
            } else if (mode === 'C') {
                angle += 0.085; // æå‡æ—‹è½¬é€Ÿåº¦
                curX = 150 + Math.cos(angle) * 75;
                curY = 100 + Math.sin(angle) * 75;
                cursor.style.left = curX + "px"; cursor.style.top = curY + "px";
            }
        }, 20);
    }

    function lockToss() {
        clearInterval(tossInterval);
        playSound('click');
        document.getElementById('lock-btn').disabled = true;

        let hit = false;
        const accRange = currentPokemon.acc * 3;
        if (mode === 'H') hit = Math.abs(curX - 150) < accRange;
        else if (mode === 'V') hit = Math.abs(curY - 100) < accRange;
        else if (mode === 'C') {
            let nA = angle % (Math.PI * 2);
            hit = Math.abs(nA) < 0.38 || Math.abs(nA - Math.PI*2) < 0.38;
        }

        const cursor = document.getElementById('toss-cursor');
        cursor.style.backgroundColor = hit ? "#2ecc71" : "#e74c3c";
        cursor.style.transform = "translate(-50%, -50%) scale(1.8)"; // è§†è§‰å®šæ ¼æ”¾å¤§
        if (hit) subWins++;

        setTimeout(() => {
            cursor.style.backgroundColor = "#222";
            cursor.style.transform = "translate(-50%, -50%) scale(1)";
            
            tossStep++;
            if (tossStep < 3) {
                // æ¯ä¸€æ¬¡ç‚¹å‡»é”å®šåï¼Œéƒ½ä¸ºä¸‹ä¸€æ¬¡éšæœºåˆ†é…æ–°æ¨¡å¼
                randomizeMode();
                startTossLoop();
            } else {
                finishRound();
            }
        }, 800); // åœæ­¢ 0.8 ç§’
    }

    function finishRound() {
        const isSuccess = subWins >= 2;
        const slot = document.getElementById(`slot-${attemptCount}`);
        
        if (isSuccess) {
            playSound('success');
            slot.innerHTML = `<img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/${currentPokemon.img}.png">`;
            successCount++;
            alert("âœ¨ æˆåŠŸæ”¶æœï¼" + currentPokemon.name + " åŠ å…¥äº†ä½ çš„é˜Ÿä¼ï¼");
        } else {
            playSound('fail');
            slot.innerHTML = "<span style='color:#bbb;font-size:12px'>é€ƒèµ°</span>";
            alert("ğŸ’¨ å“å‘€ï¼" + currentPokemon.name + " è¶æœºé€ƒèµ°äº†...");
        }

        attemptCount++;
        if (attemptCount >= 5) {
            setTimeout(() => {
                document.getElementById('screen-catch').classList.remove('active');
                document.getElementById('screen-win').classList.add('active');
                document.getElementById('final-score').innerText = `æ¢é™©ç»“æŸï¼ä½ æˆåŠŸæ”¶æœäº† ${successCount} ä¸ªä¼™ä¼´ï¼`;
            }, 500);
        } else {
            document.getElementById('screen-catch').classList.remove('active');
            document.getElementById('screen-adventure').classList.add('active');
            initRound();
        }
    }

    function updateEnergyUI() { document.getElementById('energy-fill').style.width = energy + "%"; }
</script>
</body>
</html>
