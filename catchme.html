<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¥å¥‡å®è´ï¼šå¤§å¸ˆæ’è¡Œæ¦œç‰ˆ</title>
    <style>
        :root { --primary: #ff4757; --accent: #ffa502; --bg: #f1f2f6; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); text-align: center; margin: 0; overflow: hidden; touch-action: manipulation; }
        #game-container { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; background: white; position: relative; }
        .screen { display: none; width: 100%; flex-grow: 1; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .active { display: flex; }

        /* ä¿®å¤ 1ï¼šè®­ç»ƒå¸ˆå›¾ç‰‡ç¼©å°åˆ° 1/3 */
        .trainer-container { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
        .trainer-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 5px; width: 60px; cursor: pointer; }
        .trainer-card img { width: 20px; height: 20px; border-radius: 50%; } /* åŸ 60px -> 20px */
        .trainer-card p { font-size: 10px; margin: 2px 0; }

        /* æ¸¸æˆæ ¸å¿ƒç»„ä»¶ */
        #toss-arena { width: 300px; height: 180px; position: relative; margin: 15px 0; background: #fff; border: 3px solid #333; border-radius: 12px; overflow: hidden; }
        #target-zone { position: absolute; background: rgba(46, 204, 113, 0.5); border: 2px solid #2ecc71; z-index: 1; }
        #toss-cursor { width: 20px; height: 20px; background: #222; position: absolute; border-radius: 50%; z-index: 5; border: 2px solid #fff; transform: translate(-50%, -50%); }

        /* ä¿®å¤ 2ï¼šæˆ˜ç»©å±ç²¾çµæ˜¾ç¤ºä¸æ’è¡Œæ¦œ */
        #final-team { display: flex; gap: 10px; margin: 15px 0; justify-content: center; }
        .team-slot { width: 50px; height: 50px; background: #f8f9fa; border-radius: 50%; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .team-slot img { width: 40px; }
        
        #leaderboard { margin-top: 15px; width: 80%; background: #f1f2f6; border-radius: 10px; padding: 10px; font-size: 12px; text-align: left; }
        .rank-item { display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; padding: 2px 0; }

        /* å…¶å®ƒ UI */
        .bar-container { width: 80%; height: 15px; background: #eee; border-radius: 10px; overflow: hidden; margin-bottom: 10px; border: 2px solid #444; }
        #energy-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff9f43, #ff6b6b); }
        .circle-btn { width: 80px; height: 80px; border-radius: 50%; border: none; background: var(--primary); color: white; font-weight: bold; box-shadow: 0 4px #cf3948; cursor: pointer; }
        #collection-shelf { width: 100%; height: 60px; background: #2f3542; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .slot { width: 35px; height: 35px; background: #57606f; border-radius: 5px; display: flex; align-items: center; justify-content: center; }
        .slot img { width: 30px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="screen-select" class="screen active">
        <h2>é€‰æ‹©å¤§å¸ˆä¼™ä¼´</h2>
        <div id="trainer-pannel" class="trainer-container"></div>
    </div>

    <div id="screen-adventure" class="screen">
        <p id="story-display"></p>
        <div class="bar-container"><div id="energy-fill"></div></div>
        <button class="circle-btn" onclick="addEnergy()">è“„åŠ›</button>
    </div>

    <div id="screen-catch" class="screen">
        <h3 id="toss-title"></h3>
        <img id="wild-pokemon" style="width:100px" src="">
        <div id="toss-arena">
            <div id="target-zone"></div>
            <div id="toss-cursor"></div>
        </div>
        <button id="lock-btn" class="circle-btn" style="background:var(--accent); box-shadow:0 4px #e67e22" onclick="lockToss()">æ•æ‰</button>
    </div>

    <div id="screen-win" class="screen">
        <h2 style="margin:0">å†’é™©æŠ¥å‘Š</h2>
        <div id="final-team"></div>
        
        <div id="register-area">
            <input type="text" id="player-name" placeholder="è¾“å…¥å§“åç™»è®°æˆ˜ç»©" style="padding:8px; border-radius:5px; border:1px solid #ccc">
            <button onclick="submitScore()" style="padding:8px 15px; background:var(--accent); border:none; border-radius:5px; color:white">æäº¤æ’è¡Œæ¦œ</button>
        </div>

        <div id="leaderboard">
            <strong>ğŸ† å¤§å¸ˆæ¦œå• (å‰10å)</strong>
            <div id="rank-list">åŠ è½½ä¸­...</div>
        </div>
        <button class="circle-btn" style="width:120px; height:40px; border-radius:20px; margin-top:10px" onclick="location.reload()">å†æ¥ä¸€æ¬¡</button>
    </div>

    <div id="collection-shelf">
        <div class="slot" id="slot-0"></div><div class="slot" id="slot-1"></div><div class="slot" id="slot-2"></div><div class="slot" id="slot-3"></div><div class="slot" id="slot-4"></div>
    </div>
</div>

<script>
    // é…ç½®ï¼šåœ¨æ­¤å¤„ç²˜è´´ä½ çš„ Apps Script URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzLEqUg5qyBiWN7ovedH6Gu4aYkns_Hnvm0soda2rFGRHFWHKYFbxrFycIF7ZrdF1o43A/exec";

    let attemptCount = 0, successCount = 0;
    let energy = 0, currentPokemon, tossStep, subWins, caughtList = [];
    let mode = 'H', curX = 150, curY = 90, dir = 1, angle = 0, tossInterval;

    const pokemonsPool = [
        { name: "çš®å¡ä¸˜", img: "025", difficulty: 2.9, acc: 25 },
        { name: "å¦™è›™ç§å­", img: "001", difficulty: 2.4, acc: 25 },
        { name: "å°ç«é¾™", img: "004", difficulty: 2.0, acc: 25 },
        { name: "æ°å°¼é¾Ÿ", img: "007", difficulty: 2.0, acc: 25 },
        { name: "å·´å¤§è¶", img: "012", difficulty: 1.1, acc: 30 },
        { name: "æ¯”æ¯”é¸Ÿ", img: "017", difficulty: 1.1, acc: 25 },
        { name: "ä¹å°¾", img: "038", difficulty: 2.8, acc: 20 },
        { name: "èƒ–ä¸", img: "039", difficulty: 1.8, acc: 30 },
        { name: "å¯è¾¾é¸­", img: "054", difficulty: 2.2, acc: 25 },
        { name: "é£é€Ÿç‹—", img: "059", difficulty: 2.2, acc: 18 },
        { name: "è€¿é¬¼", img: "094", difficulty: 3.3, acc: 15 },
        { name: "æš´é²¤é¾™", img: "130", difficulty: 3.5, acc: 15 },
        { name: "ä¼Šå¸ƒ", img: "133", difficulty: 1.3, acc: 25 },
        { name: "å¡æ¯”å…½", img: "143", difficulty: 3.8, acc: 18 },
        { name: "æ€¥å†»é¸Ÿ", img: "144", difficulty: 3.6, acc: 12 },
        { name: "é—ªç”µé¸Ÿ", img: "145", difficulty: 3.9, acc: 12 },
        { name: "ç«ç„°é¸Ÿ", img: "146", difficulty: 4.5, acc: 12 },
        { name: "å¿«é¾™", img: "149", difficulty: 3.0, acc: 14 },
        { name: "è¶…æ¢¦", img: "150", difficulty: 5.0, acc: 8 },
        { name: "å‡¤ç‹", img: "250", difficulty: 4.2, acc: 9 },
        { name: "æ´›å¥‡äºš", img: "249", difficulty: 4.2, acc: 9 },
        { name: "æ°´å›", img: "245", difficulty: 3.0, acc: 13 },
        { name: "ç­åŸºæ‹‰æ–¯", img: "248", difficulty: 3.2, acc: 12 },
        { name: "çƒˆç©ºå", img: "384", difficulty: 5.0, acc: 7 },
        { name: "åˆ©æ¬§è·¯", img: "447", difficulty: 2.5, acc: 22 }
    ];

    window.onload = () => {
        const pannel = document.getElementById('trainer-pannel');
        for(let i=1; i<=6; i++) {
            const card = document.createElement('div'); card.className = 'trainer-card';
            card.innerHTML = `<img src="img/${i}.png"><p>å¤§å¸ˆ ${i}</p>`;
            card.onclick = () => { document.getElementById('screen-select').classList.remove('active'); document.getElementById('screen-adventure').classList.add('active'); initRound(); };
            pannel.appendChild(card);
        }
    };

    function initRound() {
        energy = 0; currentPokemon = pokemonsPool[attemptCount % pokemonsPool.length];
        document.getElementById('story-display').innerText = `å‘ç° ${currentPokemon.name}ï¼`;
        const decay = setInterval(() => { if(energy > 0) energy -= 2; updateUI(); }, 150);
        window.roundDecay = decay;
    }

    function addEnergy() {
        energy += 10; updateUI();
        if(energy >= 100) { clearInterval(window.roundDecay); showCatch(); }
    }

    function showCatch() {
        document.getElementById('screen-adventure').classList.remove('active');
        document.getElementById('screen-catch').classList.add('active');
        document.getElementById('wild-pokemon').src = `https://assets.pokemon.com/assets/cms2/img/pokedex/full/${currentPokemon.img}.png`;
        tossStep = 0; subWins = 0; randomizeMode();
    }

    function randomizeMode() {
        const r = Math.random(); mode = r < 0.33 ? 'H' : (r < 0.66 ? 'V' : 'C');
        const zone = document.getElementById('target-zone');
        zone.style = "";
        if(mode === 'H') { zone.style.width="60px"; zone.style.height="100%"; zone.style.left="120px"; }
        else if(mode === 'V') { zone.style.height="60px"; zone.style.width="100%"; zone.style.top="60px"; }
        else { zone.style.width="40px"; zone.style.height="40px"; zone.style.left="220px"; zone.style.top="70px"; zone.style.borderRadius="50%"; }
        startLoop();
    }

    function startLoop() {
        curX = 150; curY = 90; angle = 0;
        tossInterval = setInterval(() => {
            const cursor = document.getElementById('toss-cursor');
            if(mode === 'H') { curX += 6 * dir; if(curX > 280 || curX < 20) dir *= -1; cursor.style.left = curX+"px"; cursor.style.top="90px"; }
            else if(mode === 'V') { curY += 6 * dir; if(curY > 160 || curY < 20) dir *= -1; cursor.style.top = curY+"px"; cursor.style.left="150px"; }
            else { angle += 0.1; curX = 150 + Math.cos(angle)*70; curY = 90 + Math.sin(angle)*70; cursor.style.left = curX+"px"; cursor.style.top = curY+"px"; }
        }, 20);
    }

    function lockToss() {
        clearInterval(tossInterval);
        let hit = (mode==='H' && Math.abs(curX-150)<30) || (mode==='V' && Math.abs(curY-90)<30) || (mode==='C' && Math.abs(angle%(Math.PI*2)) < 0.4);
        if(hit) subWins++;
        setTimeout(() => {
            if(++tossStep < 3) randomizeMode();
            else finish();
        }, 800);
    }

    function finish() {
        const success = subWins >= 2;
        const slot = document.getElementById(`slot-${attemptCount}`);
        if(success) {
            slot.innerHTML = `<img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/${currentPokemon.img}.png">`;
            caughtList.push(currentPokemon.img);
            successCount++;
        } else { slot.innerText = "é€ƒ"; }

        if(++attemptCount >= 5) showWin();
        else { document.getElementById('screen-catch').classList.remove('active'); document.getElementById('screen-adventure').classList.add('active'); initRound(); }
    }

    function showWin() {
        document.getElementById('screen-catch').classList.remove('active');
        document.getElementById('screen-win').classList.add('active');
        const team = document.getElementById('final-team');
        caughtList.forEach(img => {
            const div = document.createElement('div'); div.className = 'team-slot';
            div.innerHTML = `<img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/${img}.png">`;
            team.appendChild(div);
        });
        fetchLeaderboard();
    }

    async function submitScore() {
        const name = document.getElementById('player-name').value;
        if(!name) return alert("è¯·è¾“å…¥å¤§åï¼");
        const btn = event.target; btn.disabled = true; btn.innerText = "æäº¤ä¸­...";
        
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ name: name, score: successCount })
            });
            const topTen = await response.json();
            renderRanks(topTen);
            document.getElementById('register-area').style.display = 'none';
        } catch(e) { alert("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Apps Script éƒ¨ç½²"); btn.disabled = false; }
    }

    async function fetchLeaderboard() {
        // æ­¤å¤„å¯ä»¥åšä¸€ä¸ªç®€å•çš„ GET è¯·æ±‚æ¥è·å–ç°æœ‰æ’å
        document.getElementById('rank-list').innerText = "ç­‰å¾…æäº¤åæ›´æ–°æ’å...";
    }

    function renderRanks(data) {
        const list = document.getElementById('rank-list');
        list.innerHTML = data.map((item, i) => `
            <div class="rank-item">
                <span>${i+1}. ${item[0]}</span>
                <span>${item[1]} åª</span>
            </div>
        `).join('');
    }

    function updateUI() { document.getElementById('energy-fill').style.width = energy+"%"; }
</script>
</body>
</html>

