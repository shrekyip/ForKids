<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>æ–¹å‘ä¹‹å‰‘ 4.1ï¼šå°æ™ºçš„é˜²å¾¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #020617; color: white; text-align: center; overflow: hidden; height: 100vh; }
  #game { max-width: 600px; margin: auto; padding: 15px; position: relative; height: 100%; display: flex; flex-direction: column; }
  #ash-display { width: 100%; height: 180px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 10px; }
  .ash-img { width: 110px; height: 110px; border-radius: 50%; border: 4px solid #fbbf24; background: #1e293b; object-fit: cover; }
  .status-text { font-size: 0.9rem; color: #94a3b8; margin-top: 8px; font-weight: bold; }
  .enemy-img { width: 120px; height: 120px; transition: all 0.3s; }
  .message-box { height: 40px; font-size: 1.4rem; color: #fbbf24; margin: 10px 0; font-weight: bold; }
  .sequence-display { font-size: 2.2rem; min-height: 50px; letter-spacing: 10px; color: #60a5fa; }
  #blind-box { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
  .cards { display: flex; gap: 15px; margin-top: 25px; }
  .card { width: 85px; height: 130px; background: #334155; border: 2px solid #60a5fa; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; }
  #leaderboard { display: none; background: #1e293b; padding: 20px; border-radius: 20px; margin-top: 10px; border: 1px solid #334155; }
  .score-row { display: flex; justify-content: space-between; padding: 8px 15px; border-bottom: 1px solid #2d3748; }
  .buttons { display: grid; grid-template-areas: ". up ." "left down right"; gap: 15px; justify-content: center; margin-top: auto; margin-bottom: 30px; }
  .btn { width: 75px; height: 75px; font-size: 32px; border-radius: 50%; border: none; background: #334155; color: white; touch-action: manipulation; box-shadow: 0 4px 0 #1e293b; }
  .btn:active { background: #475569; transform: translateY(2px); box-shadow: none; }
  .hidden { visibility: hidden; }
  /* é”™è¯¯é—ªçƒæ•ˆæœ */
  .shake { animation: shake 0.5s; background-color: rgba(239, 68, 68, 0.2) !important; }
  @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 20% { transform: translate(-3px, 0px) rotate(-1deg); } 40% { transform: translate(3px, 2px) rotate(1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 80% { transform: translate(3px, 1px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(1deg); } }
</style>
</head>
<body id="body">

<div id="game">
  <div id="ash-display">
    <img id="ash-img" class="ash-img" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png" alt="å°æ™º">
    <div id="ash-status" class="status-text">å‡†å¤‡æˆ˜æ–—ï¼</div>
  </div>

  <div style="display: flex; justify-content: space-around; font-size: 1.2rem; margin: 15px 0;">
    <span>å›åˆ: <span id="round" style="color:#fbbf24">1</span></span>
    <span id="hp-ui">â¤ï¸â¤ï¸â¤ï¸</span>
  </div>

  <div id="enemy-area" style="height: 140px; display: flex; justify-content: center; align-items: center;">
    <div id="count-down" style="font-size: 4rem; color: #ef4444; position: absolute; z-index: 10;" class="hidden"></div>
    <img id="enemy-img" class="enemy-img" src="">
  </div>

  <div id="message" class="message-box">ç‚¹å‡»ä»»æ„æŒ‰é’®å¼€å§‹éŸ³æ•ˆ</div>
  <div id="sequence" class="sequence-display"></div>

  <div class="buttons">
    <button class="btn" style="grid-area: up" onclick="inputDir('â†‘')">â†‘</button>
    <button class="btn" style="grid-area: left" onclick="inputDir('â†')">â†</button>
    <button class="btn" style="grid-area: down" onclick="inputDir('â†“')">â†“</button>
    <button class="btn" style="grid-area: right" onclick="inputDir('â†’')">â†’</button>
  </div>

  <div id="blind-box">
    <h2 style="color:#fbbf24">è¡¥ç»™æ—¶åˆ»ï¼</h2>
    <div class="cards">
      <div class="card" onclick="pickCard(0)">?</div>
      <div class="card" onclick="pickCard(1)">?</div>
      <div class="card" onclick="pickCard(2)">?</div>
    </div>
  </div>

  <div id="leaderboard">
    <h3 style="color:#fbbf24">ğŸ† å…¨çƒæ¦œå•</h3>
    <div id="score-list">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    <button onclick="location.reload()" style="margin-top:20px; padding:12px 25px; background:#60a5fa; border:none; border-radius:10px; color:white; font-weight:bold;">å†ç©ä¸€æ¬¡</button>
  </div>
</div>

<script>
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbylH5yG9OnzlEiLsjB5-h68X5JaUeNcnSswuQVUG3zAMcf5vW9Gofwp7wZXqp7RZbhP/exec";
  const directions = ['â†‘', 'â†“', 'â†', 'â†’'];
  let round = 1, hp = 3, playedRounds = 0;
  let nextBoxAt = Math.floor(Math.random() * 4) + 3;
  let playerInput = [], sequence = [], acceptingInput = false;

  // éŸ³é¢‘ç³»ç»Ÿä¼˜åŒ–
  let audioCtx = null;
  function initAudio() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }

  function playTone(freq, type, duration) {
    if (!audioCtx) return;
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + duration);
  }

  function updateAsh() {
    const img = document.getElementById("ash-img");
    const status = document.getElementById("ash-status");
    const urls = [
      "",
      "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/25.png",
      "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png",
      "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png"
    ];
    img.src = urls[hp];
    status.textContent = hp === 3 ? "å°æ™ºï¼šæ´»åŠ›å……æ²›ï¼" : (hp === 2 ? "å°æ™ºï¼šæœ‰ç‚¹åƒåŠ›..." : "å°æ™ºï¼šéå¸¸è¾›è‹¦ï¼");
  }

  async function loadPokemon() {
    try {
        const id = Math.floor(Math.random() * 150) + 1;
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
        const data = await res.json();
        document.getElementById("enemy-img").src = data.sprites.front_default;
    } catch(e) { console.log("Pokemon Load Error"); }
  }

  async function startRound() {
    updateAsh();
    playerInput = []; sequence = [];
    document.getElementById("message").textContent = "å‡†å¤‡ï¼";
    for (let i = 3; i > 0; i--) {
      const c = document.getElementById("count-down");
      c.textContent = i; c.classList.remove("hidden");
      if (audioCtx) playTone(440, 'sine', 0.1);
      await new Promise(r => setTimeout(r, 600));
      c.classList.add("hidden");
    }
    let len = 3 + Math.floor(round / 5);
    for (let i = 0; i < len; i++) sequence.push(directions[Math.floor(Math.random() * 4)]);
    document.getElementById("sequence").textContent = sequence.join(" ");
    setTimeout(() => {
      document.getElementById("sequence").textContent = "";
      document.getElementById("message").textContent = "è¯·é˜²å¾¡ï¼"; // è¿˜åŸè¯­å¢ƒ
      acceptingInput = true;
    }, 1500);
  }

  function inputDir(dir) {
    if (audioCtx === null) initAudio();
    if (!acceptingInput) return;
    playerInput.push(dir);
    const idx = playerInput.length - 1;

    if (playerInput[idx] !== sequence[idx]) {
      // é˜²å¾¡å¤±è¯¯åé¦ˆ
      acceptingInput = false;
      playTone(150, 'sawtooth', 0.5); 
      document.getElementById("message").textContent = "âŒ é˜²å¾¡å¤±è¯¯ï¼";
      document.getElementById("body").classList.add("shake");
      setTimeout(() => {
        document.getElementById("body").classList.remove("shake");
        hp--; updateHP();
        if (hp <= 0) gameOver(); else setTimeout(checkBlindBox, 800);
      }, 500);
      return;
    }

    playTone(600 + (idx * 100), 'sine', 0.1);
    if (playerInput.length === sequence.length) {
      acceptingInput = false;
      document.getElementById("message").textContent = "âœ… å®Œç¾é˜²å¾¡ï¼";
      setTimeout(checkBlindBox, 800);
    }
  }

  function checkBlindBox() {
    playedRounds++;
    if (playedRounds >= nextBoxAt) {
      playedRounds = 0; nextBoxAt = Math.floor(Math.random() * 4) + 3;
      document.getElementById("blind-box").style.display = "flex";
    } else { nextRound(); }
  }

  function pickCard(choice) {
    const isHealing = Math.random() < 0.6;
    if (isHealing) playTone(800, 'sine', 0.2);
    alert(isHealing ? "è¿æ°”ä¸é”™ï¼ä½“åŠ›æ¢å¤â¤ï¸" : "æ˜¯ç©ºç›’ï¼Œç»§ç»­åŠ æ²¹ï¼ğŸ’¨");
    if (isHealing && hp < 3) { hp++; updateHP(); }
    document.getElementById("blind-box").style.display = "none";
    nextRound();
  }

  function nextRound() {
    round++;
    document.getElementById("round").textContent = round;
    loadPokemon().then(startRound);
  }

  function updateHP() {
    document.getElementById("hp-ui").textContent = "â¤ï¸".repeat(hp);
    updateAsh();
  }

  async function gameOver() {
    document.getElementById("message").textContent = "ğŸ’€ æˆ˜æ–—ç»“æŸ";
    try {
        const name = prompt("è¿›å…¥ç»“ç®—ï¼è¯·è¾“å…¥ä½ çš„åå­—è®°å½•åˆ†æ•°:", "è®­ç»ƒå®¶");
        if (name) {
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ name: name, score: round })
            });
        }
    } catch (e) { console.log("Cloud Save Error"); }
    
    document.getElementById("leaderboard").style.display = "block";
    document.querySelector(".buttons").style.display = "none";
    fetchScores();
  }

  async function fetchScores() {
    const list = document.getElementById("score-list");
    try {
        const res = await fetch(GOOGLE_SCRIPT_URL);
        const data = await res.json();
        list.innerHTML = data.map((s, i) => `
          <div class="score-row"><span>${i+1}. ${s[0]}</span><span>${s[1]} å›åˆ</span></div>
        `).join('');
    } catch(e) {
        list.innerHTML = "æ— æ³•åŠ è½½å…¨çƒæ¦œå•ï¼Œè¯·æ£€æŸ¥ Google æƒé™è®¾ç½®ã€‚";
    }
  }

  loadPokemon().then(startRound);
</script>
</body>
</html>
